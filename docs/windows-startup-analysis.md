# Анализ: запуск sing-box под Windows (первая попытка часто не срабатывает)

## Как сейчас запускается sing-box под Windows

1. **Общая ветка** (не macOS с TUN): `exec.Command(singboxPath, "run", "-c", filepath.Base(configPath))`, `Dir = bin/`, stdout/stderr в `ChildLogFile`, `platform.PrepareCommand` (Windows: `CREATE_NO_WINDOW` + скрытое окно).
2. **Только Windows**: перед запуском из конфига читается имя TUN; если интерфейс с таким именем есть — вызывается `removeTunInterface()` (netsh show → netsh delete). Ошибка удаления только логируется, запуск не отменяется.
3. **Запуск**: `ac.SingboxCmd.Start()`. При ошибке — `ShowStartupError()` и выход. При успехе — ставится «running», в горутине вызывается `Monitor(cmd)` (ждёт `cmd.Wait()`).
4. **При падении процесса**: `Monitor` считает краш, ждёт 2 секунды и вызывает `Start(true)` (автоперезапуск).

«Вторая попытка» = либо повторное нажатие Start, либо автоматический перезапуск после краша.

---

## Предположения (гипотезы)

### 1. TUN / Wintun не успевают освободиться
- После `netsh interface delete` Windows/драйвер может не сразу освободить имя/ресурс.
- Запуск sing-box идёт сразу без задержки → возможна ошибка «уже существует» → краш → автоперезапуск через 2 с успешен.
- **TODO**: при удалении TUN добавить короткую задержку (1–2 с) перед `exec.Start()` и/или проверить логи sing-box на ошибки создания интерфейса.

### 2. «Холодный» старт Wintun после перезагрузки
- При первом обращении к Wintun драйвер поднимается; инициализация может давать сбой при первом создании адаптера.
- **TODO**: собрать логи sing-box при первой неудачной попытке после перезагрузки; при необходимости рассмотреть задержку или повторную попытку запуска на уровне launcher.

### 3. Ошибка при создании процесса (Start() возвращает err)
- Например: не найден wintun.dll, блокировка антивирусом. Показывается диалог, автоперезапуск не вызывается — пользователь жмёт Start снова.
- **TODO**: в документации/UI подсказать проверять антивирус и наличие wintun.dll; при желании — вторая автоматическая попытка при определённых ошибках (осторожно с UX).

### 4. Автозапуск с `-start`: слишком рано
- Задержка 1 с после старта приложения может быть мала: сеть/драйверы ещё не готовы → краш → автоперезапуск через 2 с успешен.
- **TODO**: рассмотреть увеличение `autoStartDelay` для Windows (например, 3–5 с) или опцию в настройках.

### 5. Один и тот же лог-файл у launcher и sing-box
- Теоретически возможны гонки при наследовании дескриптора. Менее вероятно.
- **TODO**: только при появлении подтверждённых багов — рассмотреть отдельный fd для дочернего процесса или буферизацию.

### 6. CREATE_NO_WINDOW при раннем старте
- Редкие сценарии нестабильности при первом создании процесса с CREATE_NO_WINDOW сразу после входа в систему.
- **TODO**: при воспроизведении — рассмотреть повторную попытку с той же командой без изменения флагов.

---

## Что проверить по логам (без правок)

- **sing-box.log**: при первой неудачной попытке — ошибки создания TUN, wintun, binding port.
- **singbox-launcher.log**: есть ли `startSingBox: Failed to start Sing-Box:` (ошибка на этапе `Start()`) или процесс стартует, а выход приходит в `Monitor` (падение внутри sing-box).
- Конфиг: используется ли TUN (`inbounds` с `"type": "tun"` и `interface_name`).
- Запуск с `-start` или без: при `-start` особенно вероятна гипотеза 4.

---

## Ссылки на код

- Запуск: `core/process_service.go` — `Start()`, блок `runtime.GOOS == "windows"` (TUN), `exec.Command` и `Monitor`.
- TUN: `removeTunInterface`, `checkTunInterfaceExists` в `core/process_service.go`; `config.GetTunInterfaceName` в `core/config/config_loader.go`.
- Windows: `internal/platform/platform_windows.go` — `PrepareCommand`, `GetProcessNameForCheck`.
- Автозапуск: `main.go` — `autoStartDelay`, `-start` и вызов `core.StartSingBoxProcess()`.
