# Создание собственного шаблона визарда конфигурации

Это руководство предназначено для **провайдеров VPN и администраторов сервисов**, которые хотят создать собственный шаблон конфигурации (`config_template.json`), который пользователи смогут настраивать через встроенный визард.

---

## Что такое визард конфигурации?

Визард конфигурации — это визуальный интерфейс, который помогает пользователям создать файл `config.json` без ручного редактирования JSON. Как провайдер, вы создаёте файл-шаблон (`config_template.json`), который определяет:

- Настройки по умолчанию (DNS, логирование, правила маршрутизации)
- Какие правила пользователи могут включать/выключать через чекбоксы
- Как вставляются сгенерированные прокси-аутбаунды
- Группы прокси и селекторы по умолчанию

Пользователи просто:
1. Вводят URL своей подписки или прямые ссылки на прокси
2. Выбирают, какие опциональные правила включить
3. Нажимают "Save" для генерации своего `config.json`

---

## Быстрый старт

### Шаг 1: Создайте файл шаблона

Создайте файл с именем `config_template.json` в папке `bin/` (рядом с исполняемым файлом приложения).

### Шаг 2: Используйте минимальный шаблон

Скопируйте этот скелет и настройте под себя:

```jsonc
{
  /** @ParcerConfig
    {
      "ParserConfig": {
        "version": 2,
        "proxies": [
          {
            "source": "https://your-subscription-url-here"
          }
        ],
        "outbounds": [
          {
            "tag": "auto-proxy-out",
            "type": "urltest",
            "options": {
              "url": "https://cp.cloudflare.com/generate_204",
              "interval": "5m",
              "tolerance": 100
            },
            "outbounds": {
              "proxies": {}
            }
          },
          {
            "tag": "proxy-out",
            "type": "selector",
            "options": {
              "default": "auto-proxy-out"
            },
            "outbounds": {
              "addOutbounds": ["direct-out", "auto-proxy-out"],
              "proxies": {}
            }
          }
        ]
      }
    }
  */

  "log": {
    "level": "info",
    "timestamp": true
  },

  "dns": {
    "servers": [
      {
        "type": "udp",
        "tag": "direct_dns",
        "server": "9.9.9.9",
        "server_port": 53
      }
    ],
    "final": "direct_dns"
  },

  "inbounds": [
    {
      "type": "tun",
      "tag": "tun-in",
      "interface_name": "singbox-tun0",
      "address": ["172.16.0.1/30"],
      "mtu": 1400,
      "auto_route": true,
      "strict_route": false,
      "stack": "system"
    }
  ],

  "outbounds": [
    /** @PARSER_OUTBOUNDS_BLOCK */
    { "type": "direct", "tag": "direct-out" }
  ],

  "route": {
    "rules": [
      { "ip_is_private": true, "outbound": "direct-out" },
      { "domain_suffix": ["local"], "outbound": "direct-out" },
      
      /** @SelectableRule
        @label Блокировка рекламы
        @description Мягко блокировать рекламу, отклоняя соединения
        @default
        { "rule_set": "ads-all", "action": "reject" },
      */
      
      /** @SelectableRule
        @label Российские домены напрямую
        @description Отправлять трафик российских доменов напрямую
        { "rule_set": "ru-domains", "outbound": "direct-out" },
      */
    ],
    "final": "proxy-out"
  },

  "experimental": {
    "clash_api": {
      "external_controller": "127.0.0.1:9090",
      "secret": "CHANGE_THIS_TO_YOUR_SECRET_TOKEN"
    }
  }
}
```

### Шаг 3: Настройте под свой сервис

1. **Обновите `@ParcerConfig`**: Замените `"source": "https://your-subscription-url-here"` на реальный URL вашей подписки (или оставьте пустым, если пользователи будут вводить свой)
2. **Настройте группы аутбаундов**: Измените массив `outbounds` в `@ParcerConfig` под структуру ваших прокси-групп
3. **Добавьте свои правила**: Замените примеры `@SelectableRule` на свои правила маршрутизации
4. **Установите финальный аутбаунд по умолчанию**: Измените `"final": "proxy-out"` на тег вашей прокси-группы по умолчанию

---

## Понимание специальных маркеров

### 1. Блок `@ParcerConfig`

**Назначение**: Определяет конфигурацию парсера подписок по умолчанию.

**Расположение**: Должен быть блок-комментарием `/** @ParcerConfig ... */` в начале шаблона.

**Что содержит**:
- `version`: Всегда используйте `2`
- `proxies`: Массив с URL подписок (пользователи могут переопределить их в визарде)
- `outbounds`: Группы прокси по умолчанию (urltest, selector и т.д.), которые будут доступны пользователям

**Пример**:
```jsonc
/** @ParcerConfig
  {
    "ParserConfig": {
      "version": 2,
      "proxies": [{ "source": "https://example.com/subscription" }],
      "outbounds": [
        {
          "tag": "auto-proxy-out",
          "type": "urltest",
          "options": { "url": "https://cp.cloudflare.com/generate_204", "interval": "5m" },
          "outbounds": { "proxies": {} }
        }
      ]
    }
  }
*/
```

**Важно**: Визард автоматически нормализует это до формата версии 2. Убедитесь, что все значения `tag` соответствуют тем, на которые вы ссылаетесь в секции `route`.

---

### 2. Маркер `@PARSER_OUTBOUNDS_BLOCK`

**Назначение**: Указывает визарду, куда вставлять сгенерированные прокси-аутбаунды из подписки пользователя.

**Расположение**: Должен быть внутри массива `outbounds` как комментарий.

**Как работает**:
- Визард парсит URL подписки пользователя или прямые ссылки
- Генерирует отдельные прокси-аутбаунды (vless://, vmess:// и т.д.)
- Вставляет их в место расположения `@PARSER_OUTBOUNDS_BLOCK`
- Все аутбаунды **после** этого маркера сохраняются (например, `direct-out`)

**Пример**:
```jsonc
"outbounds": [
  /** @PARSER_OUTBOUNDS_BLOCK */
  { "type": "direct", "tag": "direct-out" },
  { "type": "block", "tag": "block-out" }
]
```

**Результат**: Сгенерированные прокси появляются первыми, затем `direct-out`, затем `block-out`.

---

### 3. Блоки `@SelectableRule`

**Назначение**: Создаёт удобные чекбоксы для опциональных правил маршрутизации.

**Расположение**: Должны быть внутри массива `route.rules` как блок-комментарии.

**Структура**:
```jsonc
/** @SelectableRule
  @label Отображаемое имя
  @description Подробное объяснение, показываемое во всплывающей подсказке
  @default
  { "rule_set": "example", "outbound": "proxy-out" },
*/
```

**Директивы** (все опциональны):
- `@label Текст` - Метка чекбокса (рекомендуется для ясности)
- `@description Текст` - Показывается при нажатии кнопки "?"
- `@default` - Правило включено по умолчанию

**Формат правила**: Может быть одним объектом правила или массивом правил:
```jsonc
// Одно правило
/** @SelectableRule
  @label Блокировка рекламы
  { "rule_set": "ads-all", "action": "reject" },
*/

// Несколько правил (массив)
/** @SelectableRule
  @label Правила для игр
  [
    { "rule_set": "games", "outbound": "direct-out" },
    { "port": [27000, 27001], "outbound": "direct-out" }
  ],
*/
```

**Выбор аутбаунда**: Если ваше правило имеет поле `outbound`, визард автоматически показывает выпадающий список, чтобы пользователи могли выбрать, какую прокси-группу использовать. Доступные варианты берутся из:
- Тегов, определённых в `@ParcerConfig` outbounds
- Тегов из сгенерированных прокси
- Всегда доступны: `direct-out`, `reject`, `drop`

**Особый случай - правила reject**: Если ваше правило имеет `"action": "reject"`, визард предлагает варианты `reject` и `drop` вместо прокси-групп.

---

## Полный пример: Реальный шаблон

Вот более полный пример, демонстрирующий лучшие практики:

```jsonc
{
  /** @ParcerConfig
    {
      "ParserConfig": {
        "version": 2,
        "proxies": [
          {
            "source": "https://your-vpn-service.com/api/subscription?token=USER_TOKEN"
          }
        ],
        "outbounds": [
          {
            "tag": "auto-proxy-out",
            "type": "urltest",
            "options": {
              "url": "https://cp.cloudflare.com/generate_204",
              "interval": "5m",
              "tolerance": 100,
              "interrupt_exist_connections": true
            },
            "outbounds": {
              "proxies": {}
            },
            "comment": "Автоматический выбор самого быстрого прокси"
          },
          {
            "tag": "proxy-out",
            "type": "selector",
            "options": {
              "interrupt_exist_connections": true,
              "default": "auto-proxy-out"
            },
            "outbounds": {
              "addOutbounds": ["direct-out", "auto-proxy-out"],
              "proxies": {}
            },
            "comment": "Основной селектор прокси"
          }
        ]
      }
    }
  */

  "log": {
    "level": "warn",
    "timestamp": true
  },

  "dns": {
    "servers": [
      {
        "type": "udp",
        "tag": "direct_dns",
        "server": "9.9.9.9",
        "server_port": 53
      },
      {
        "type": "https",
        "tag": "cloudflare_doh",
        "server": "1.1.1.1",
        "server_port": 443,
        "path": "/dns-query"
      }
    ],
    "rules": [
      { "server": "cloudflare_doh" }
    ],
    "final": "direct_dns"
  },

  "inbounds": [
    {
      "type": "tun",
      "tag": "tun-in",
      "interface_name": "singbox-tun0",
      "address": ["172.16.0.1/30"],
      "mtu": 1400,
      "auto_route": true,
      "strict_route": false,
      "stack": "system"
    }
  ],

  "outbounds": [
    /** @PARSER_OUTBOUNDS_BLOCK */
    { "type": "direct", "tag": "direct-out" },
    { "type": "block", "tag": "block-out" }
  ],

  "route": {
    "rule_set": [
      {
        "tag": "ads-all",
        "type": "remote",
        "format": "binary",
        "url": "https://raw.githubusercontent.com/v2fly/domain-list-community/release/geosite-category-ads-all.srs",
        "download_detour": "direct-out",
        "update_interval": "24h"
      },
      {
        "tag": "ru-domains",
        "type": "inline",
        "format": "domain_suffix",
        "rules": [
          { "domain_suffix": ["ru", "xn--p1ai"] }
        ]
      }
    ],
    "rules": [
      { "inbound": "tun-in", "action": "resolve", "strategy": "prefer_ipv4" },
      { "inbound": "tun-in", "action": "sniff", "timeout": "1s" },
      { "protocol": "dns", "action": "hijack-dns" },
      { "ip_is_private": true, "outbound": "direct-out" },
      { "domain_suffix": ["local"], "outbound": "direct-out" },
      
      /** @SelectableRule
        @label Блокировка рекламы
        @description Мягко блокировать рекламу, отклоняя соединения (рекомендуется)
        @default
        { "rule_set": "ads-all", "action": "reject" },
      */
      
      /** @SelectableRule
        @label Российские домены напрямую
        @description Маршрутизировать российские домены напрямую (быстрее для локальных сервисов)
        { "rule_set": "ru-domains", "outbound": "direct-out" },
      */
      
      /** @SelectableRule
        @label Игровой трафик напрямую
        @description Маршрутизировать игровой трафик напрямую для меньшей задержки
        @default
        { "rule_set": "games", "outbound": "direct-out" },
      */
    ],
    "final": "proxy-out",
    "auto_detect_interface": true
  },

  "experimental": {
    "clash_api": {
      "external_controller": "127.0.0.1:9090",
      "secret": "CHANGE_THIS_TO_YOUR_SECRET_TOKEN"
    }
  }
}
```

---

## Лучшие практики

### 1. Всегда включайте статические аутбаунды

Оставьте хотя бы `direct-out` после `@PARSER_OUTBOUNDS_BLOCK`. Пользователям он нужен для локального трафика и как запасной вариант.

### 2. Используйте понятные метки и описания

Хорошие метки помогают пользователям понять, что делает каждое правило:
- ✅ `@label Блокировка рекламы` 
- ❌ `@label Правило 1`

Хорошие описания объясняют влияние:
- ✅ `@description Мягко блокировать рекламу, отклоняя соединения вместо сброса пакетов`
- ❌ `@description Блокирует рекламу`

### 3. Устанавливайте разумные значения по умолчанию

Используйте `@default` для правил, которые большинство пользователей должны включить:
- Блокировка рекламы
- Общие правила гео-маршрутизации
- Оптимизации производительности

Не используйте `@default` для:
- Экспериментальных функций
- Правил, которые могут сломать обычные сервисы
- Региональных правил (если только вы не нацелены на этот регион)

### 4. Согласовывайте имена тегов

Убедитесь, что все значения `tag`, на которые ссылаются в `route.rules`, существуют в:
- Ваших `@ParcerConfig` outbounds, ИЛИ
- Статических outbounds после `@PARSER_OUTBOUNDS_BLOCK`, ИЛИ
- Будут сгенерированы из подписок

### 5. Проверяйте валидность JSON

После удаления комментариев ваш шаблон должен быть валидным JSON. Проверьте его:
```bash
# Используя jq (если установлен)
cat config_template.json | jq . > /dev/null

# Или используйте онлайн-валидатор JSON
```

### 6. Сохраняйте логичный порядок секций

Визард сохраняет порядок ваших секций. Организуйте логично:
1. `log` - Настройки логирования
2. `dns` - Конфигурация DNS
3. `inbounds` - Входящие соединения
4. `outbounds` - Исходящие соединения (с `@PARSER_OUTBOUNDS_BLOCK`)
5. `route` - Правила маршрутизации
6. `experimental` - Экспериментальные функции

---

## Тестирование вашего шаблона

### Шаг 1: Разместите файл

Поместите `config_template.json` в папку `bin/` рядом с исполняемым файлом.

### Шаг 2: Запустите визард

1. Запустите приложение
2. Откройте визард конфигурации (обычно из главного меню или вкладки Tools)
3. Убедитесь, что шаблон загружается без ошибок

### Шаг 3: Протестируйте пользовательский поток

1. **Вкладка 1 (Источники & Parser)**:
   - Введите тестовый URL подписки или прямую ссылку
   - Нажмите "Check" - должно успешно провериться
   - Нажмите "Parse" - должно сгенерировать превью аутбаундов

2. **Вкладка 2 (Правила)**:
   - Убедитесь, что все ваши чекбоксы `@SelectableRule` отображаются
   - Проверьте, что выпадающие списки аутбаундов показывают правильные варианты
   - Включите/выключите некоторые правила

3. **Вкладка 3 (Превью)**:
   - Нажмите "Show Preview"
   - Убедитесь, что сгенерированный конфиг выглядит правильно
   - Проверьте, что выбранные правила включены
   - Убедитесь, что `@PARSER_OUTBOUNDS_BLOCK` был заменён на сгенерированные прокси

4. **Сохранение**:
   - Нажмите "Save"
   - Убедитесь, что `config.json` создан
   - Проверьте, что старый конфиг был сохранён в резервную копию (если существовал)
   - Убедитесь, что `experimental.clash_api.secret` был сгенерирован

---

## Решение проблем

### Шаблон не загружается

**Проблема**: Визард показывает "Файл шаблона не найден" или ошибки JSON.

**Решения**:
- Убедитесь, что файл назван точно `config_template.json` (с учётом регистра)
- Убедитесь, что файл находится в папке `bin/`
- Проверьте синтаксис JSON (удалите комментарии и протестируйте)
- Проверьте наличие лишних запятых или синтаксических ошибок

### Сгенерированные аутбаунды не появляются

**Проблема**: После парсинга в превью не показываются аутбаунды.

**Решения**:
- Убедитесь, что маркер `@PARSER_OUTBOUNDS_BLOCK` существует в массиве `outbounds`
- Проверьте доступность URL подписки
- Убедитесь, что формат подписки поддерживается (vless://, vmess://, trojan://, ss://)
- Проверьте логи в папке `logs/` на ошибки парсинга

### Правила не отображаются в визарде

**Проблема**: Блоки `@SelectableRule` не появляются как чекбоксы.

**Решения**:
- Убедитесь, что `@SelectableRule` написано правильно (с учётом регистра)
- Убедитесь, что блок находится внутри массива `route.rules`
- Проверьте, что JSON внутри блока валиден
- Убедитесь, что директива `@label` присутствует

### Теги аутбаундов не найдены

**Проблема**: Визард показывает ошибки "аутбаунд не найден".

**Решения**:
- Убедитесь, что все упомянутые теги существуют в `@ParcerConfig` outbounds
- Убедитесь, что тег `final` существует
- Проверьте, что сгенерированные прокси будут иметь соответствующие теги (если используете фильтры тегов)
- Добавьте отсутствующие аутбаунды в статическую секцию после `@PARSER_OUTBOUNDS_BLOCK`

---

## Продвинутые советы

### Динамические URL подписок

Если пользователям нужно вводить свой URL подписки, оставьте `source` пустым или используйте плейсхолдер:
```jsonc
"proxies": [{ "source": "" }]
```

Пользователи введут свой URL на первой вкладке визарда.

### Несколько источников подписок

Поддержка нескольких подписок:
```jsonc
"proxies": [
  { "source": "https://provider1.com/subscription" },
  { "source": "https://provider2.com/subscription" }
]
```

Пользователи могут добавить больше в интерфейсе визарда.

### Условные правила на основе выбора аутбаунда

Когда правило имеет `outbound`, пользователи могут выбирать из доступных тегов. Убедитесь, что ваш `@ParcerConfig` определяет все варианты, которые могут понадобиться пользователям.

### Пользовательские наборы правил

Ссылайтесь на удалённые наборы правил в `route.rule_set`:
```jsonc
"rule_set": [
  {
    "tag": "ads-all",
    "type": "remote",
    "format": "binary",
    "url": "https://example.com/rules/ads.srs",
    "download_detour": "direct-out",
    "update_interval": "24h"
  }
]
```

Затем ссылайтесь на них в блоках `@SelectableRule`.

---

## Распространение

При распространении вашего настроенного лаунчера:

1. Включите `config_template.json` в пакет релиза
2. Поместите его в папку `bin/`
3. Пользователи автоматически будут использовать его при открытии визарда конфигурации
4. Рассмотрите возможность документирования ваших конкретных правил и опций в отдельном README

---

## Нужна помощь?

- **Проблемы с синтаксисом шаблона**: Проверьте примеры в этом руководстве
- **Конфигурация sing-box**: См. [официальную документацию sing-box](https://sing-box.sagernet.org/configuration/)
- **Формат ParserConfig**: См. [ParserConfig.md](ParserConfig.md) в этом репозитории
- **Сообщить об ошибках**: Откройте issue на [GitHub](https://github.com/Leadaxe/singbox-launcher/issues)

---

**Примечание**: Эта система шаблонов визарда разработана для упрощения конфигурации для конечных пользователей. Как провайдер, вы сохраняете полный контроль над конфигурацией по умолчанию, предоставляя пользователям гибкость для настройки своей установки.
