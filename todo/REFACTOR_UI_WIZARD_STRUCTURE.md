# TODO: Рефакторинг структуры UI визарда конфигурации

## Описание задачи

Провести рефакторинг структуры UI визарда конфигурации с целью улучшения организации кода, разделения ответственности между UI компонентами и бизнес-логикой, упрощения навигации и поддержки.

**Подход: Чистая архитектура UI**
- **Разделение UI и бизнес-логики** - UI компоненты отделены от бизнес-логики
- **Модульная структура** - каждый шаг визарда в отдельном модуле
- **Централизованное состояние** - единая точка управления состоянием визарда
- **Переиспользуемые компоненты** - общие UI компоненты вынесены в отдельные модули
- **Разрешено менять публичный API** - можно изменять структуру и импорты в ui/ пакете

## Проблемы текущей структуры

1. **Монолитный файл**: `config_wizard.go` содержит 2284-2540 строк с множеством смешанных ответственностей (критично - см. CODE_INSPECTION_REPORT.md #2)
2. **Смешанная логика**: UI компоненты, бизнес-логика парсинга, работа с шаблонами и валидация находятся в одном файле
3. **Дублирование кода**: Утилиты парсинга и форматирования разбросаны по разным файлам
4. **Слабая модульность**: Шаги визарда не выделены в отдельные модули, сложно добавлять новые шаги
5. **Неясная структура**: `wizard/source_step.go` частично реализован, но не используется в основном коде
6. **Смешанные ответственности**: `config_wizard_rule_dialog.go` содержит и UI диалога, и утилиты парсинга
7. **Отсутствие валидации**: Недостаточная валидация входных данных (URL, размеры JSON, таймауты) - см. CODE_INSPECTION_REPORT.md #5
8. **Непоследовательная обработка ошибок**: Смешанные подходы к обработке ошибок (логирование vs возврат) - см. CODE_INSPECTION_REPORT.md #8
9. **Потенциальные утечки ресурсов**: Файловые дескрипторы и HTTP клиенты могут не закрываться правильно - см. CODE_INSPECTION_REPORT.md #7
10. **Смешанные языки в комментариях**: Комментарии частично на русском, частично на английском - см. CODE_INSPECTION_REPORT.md #4
11. **Магические числа**: Таймауты и лимиты не вынесены в константы - см. CODE_INSPECTION_REPORT.md #11

## Цель

Создать логичную структуру:
- `ui/wizard/` - основной пакет визарда с модульной структурой шагов
- `ui/wizard/state/` - управление состоянием визарда
- `ui/wizard/tabs/` - UI компоненты вкладок
- `ui/wizard/dialogs/` - диалоги визарда
- `ui/wizard/business/` - бизнес-логика (парсинг, генерация, валидация)
- `ui/wizard/template/` - работа с шаблонами
- `ui/wizard/utils/` - утилиты и вспомогательные функции

## Итоговая структура

```
ui/
├── wizard/                           # ← НОВЫЙ основной пакет визарда
│   ├── wizard.go                     # ← НОВЫЙ (точка входа ShowConfigWizard)
│   │   - ShowConfigWizard()
│   │   - Инициализация визарда
│   │   - Координация шагов
│   │
│   ├── state/                        # ← НОВЫЙ подпакет: управление состоянием
│   │   ├── state.go                  # ← ПЕРЕНЕСТИ из config_wizard_state.go
│   │   │   - WizardState struct
│   │   │   - SelectableRuleState struct
│   │   │   - Константы (defaultOutboundTag, rejectActionName)
│   │   │
│   │   └── helpers.go                 # ← НОВЫЙ
│   │       - safeFyneDo()
│   │       - debugLog(), infoLog(), errorLog()
│   │
│   ├── tabs/                         # ← НОВЫЙ подпакет: UI компоненты вкладок
│   │   ├── source_tab.go             # ← ПЕРЕНЕСТИ createVLESSSourceTab из config_wizard.go
│   │   │   - createVLESSSourceTab()
│   │   │   - UI компоненты первой вкладки
│   │   │
│   │   ├── rules_tab.go              # ← ПЕРЕНЕСТИ createTemplateTab из config_wizard.go
│   │   │   - createTemplateTab()
│   │   │   - createRulesScroll()
│   │   │   - UI компоненты вкладки правил
│   │   │
│   │   └── preview_tab.go            # ← ПЕРЕНЕСТИ createPreviewTab из config_wizard.go
│   │       - createPreviewTab()
│   │       - UI компоненты вкладки превью
│   │
│   ├── dialogs/                      # ← НОВЫЙ подпакет: диалоги визарда
│   │   └── rule_dialog.go            # ← ПЕРЕНЕСТИ из config_wizard_rule_dialog.go
│   │       - showAddRuleDialog()
│   │       - extractStringArray()
│   │       - parseLines()
│   │
│   ├── business/                     # ← НОВЫЙ подпакет: бизнес-логика
│   │   ├── parser.go                 # ← НОВЫЙ
│   │   │   - parseAndPreview()
│   │   │   - checkURL()
│   │   │   - applyURLToParserConfig()
│   │   │
│   │   ├── generator.go              # ← НОВЫЙ
│   │   │   - buildTemplateConfig()
│   │   │   - buildParserOutboundsBlock()
│   │   │   - mergeRouteSection()
│   │   │
│   │   ├── validator.go              # ← НОВЫЙ
│   │   │   - validateParserConfig()
│   │   │   - validateURLs()
│   │   │   - validateRules()
│   │   │
│   │   └── loader.go                 # ← НОВЫЙ
│   │       - loadConfigFromFile()
│   │       - serializeParserConfig()
│   │       - ensureRequiredOutbounds()
│   │
│   ├── template/                     # ← НОВЫЙ подпакет: работа с шаблонами
│   │   ├── loader.go                 # ← ПЕРЕНЕСТИ из config_template_loader.go
│   │   │   - loadTemplateData()
│   │   │   - TemplateData struct
│   │   │   - TemplateSelectableRule struct
│   │   │
│   │   ├── processor.go              # ← НОВЫЙ
│   │   │   - initializeTemplateState()
│   │   │   - ensureRequiredOutbounds()
│   │   │   - cloneOutbound()
│   │   │   - cloneRule()
│   │   │
│   │   └── formatter.go              # ← НОВЫЙ
│   │       - formatSectionJSON()
│   │       - indentMultiline()
│   │       - formatRouteSection()
│   │
│   └── utils/                        # ← НОВЫЙ подпакет: утилиты
│       ├── outbound.go               # ← НОВЫЙ
│       │   - getAvailableOutbounds()
│       │   - ensureDefaultOutbound()
│       │   - ensureDefaultAvailableOutbounds()
│       │   - ensureFinalSelected()
│       │   - getEffectiveOutbound()
│       │
│       ├── preview.go                 # ← НОВЫЙ
│       │   - setPreviewText()
│       │   - setTemplatePreviewText()
│       │   - updateTemplatePreviewAsync()
│       │   - triggerParseForPreview()
│       │
│       ├── navigation.go              # ← НОВЫЙ
│       │   - updateNavigationButtons()
│       │   - refreshRulesTab()
│       │   - refreshOutboundOptions()
│       │
│       ├── comparison.go              # ← НОВЫЙ
│       │   - outboundsMatchStrict()
│       │   - stringSlicesEqual()
│       │   - mapsEqual()
│       │   - valuesEqual()
│       │
│       └── constants.go               # ← НОВЫЙ
│           - Константы таймаутов (HTTP запросы, парсинг)
│           - Константы лимитов (размеры файлов, JSON, URI)
│           - Константы UI (размеры окон, лимиты превью)
│
├── config_wizard.go                  # ← УДАЛИТЬ (содержимое распределено)
├── config_wizard_state.go            # ← УДАЛИТЬ (содержимое в wizard/state/)
├── config_wizard_rule_dialog.go     # ← УДАЛИТЬ (содержимое в wizard/dialogs/)
└── config_template_loader.go         # ← УДАЛИТЬ (содержимое в wizard/template/)
```

## Детальное распределение

### Шаг 1: Создать `ui/wizard/state/`

**Создать подпакет `wizard/state/` для управления состоянием**

#### 1.1: `wizard/state/state.go`

**Ответственность:** Определение структур состояния визарда

**Содержимое:**
- Структура состояния визарда со всеми полями для UI компонентов
- Структура состояния правил для шаблонов
- Константы для значений по умолчанию (defaultOutboundTag, rejectActionName, rejectActionMethod)

**Источник:** Весь файл `ui/config_wizard_state.go` переносится сюда

**Важно:** Состояние остается в отдельном пакете для четкого разделения данных и логики

#### 1.2: `wizard/state/helpers.go`

**Ответственность:** Вспомогательные функции для работы с состоянием и UI

**Содержимое:**
- Безопасный вызов Fyne функций (safeFyneDo)
- Функции логирования (debugLog, infoLog, errorLog)

**Источник:** Вспомогательные функции из `ui/config_wizard_state.go`

---

### Шаг 2: Создать `ui/wizard/tabs/`

**Создать подпакет `wizard/tabs/` для UI компонентов вкладок**

#### 2.1: `wizard/tabs/source_tab.go`

**Ответственность:** UI компоненты первой вкладки (источники и ParserConfig)

**Содержимое:**
- Создание UI компонентов для ввода URL подписок
- Создание UI компонентов для ParserConfig
- Создание UI компонентов для превью outbounds
- Управление видимостью и состоянием компонентов

**Источник:** Функция `createVLESSSourceTab()` из `ui/config_wizard.go`

**Зависимости:** Использует типы из `wizard/state` для состояния

#### 2.2: `wizard/tabs/rules_tab.go`

**Ответственность:** UI компоненты вкладки правил

**Содержимое:**
- Создание UI компонентов для выбора правил из шаблона
- Создание UI компонентов для пользовательских правил
- Создание UI компонентов для выбора final outbound
- Управление состоянием правил

**Источник:** Функция `createTemplateTab()` и `createRulesScroll()` из `ui/config_wizard.go`

**Зависимости:** Использует типы из `wizard/state` и функции из `wizard/dialogs`

#### 2.3: `wizard/tabs/preview_tab.go`

**Ответственность:** UI компоненты вкладки превью

**Содержимое:**
- Создание UI компонентов для отображения превью конфигурации
- Создание кнопки генерации превью
- Управление статусом генерации

**Источник:** Функция `createPreviewTab()` из `ui/config_wizard.go`

**Зависимости:** Использует типы из `wizard/state` и функции из `wizard/business` для генерации

---

### Шаг 3: Создать `ui/wizard/dialogs/`

**Создать подпакет `wizard/dialogs/` для диалогов визарда**

#### 3.1: `wizard/dialogs/rule_dialog.go`

**Ответственность:** Диалог добавления/редактирования правил

**Содержимое:**
- Создание и управление диалогом для правил
- Валидация полей диалога
- Обработка сохранения правил
- Утилиты парсинга строк (extractStringArray, parseLines)

**Источник:** Весь файл `ui/config_wizard_rule_dialog.go` переносится сюда

**Зависимости:** Использует типы из `wizard/state`

---

### Шаг 4: Создать `ui/wizard/business/`

**Создать подпакет `wizard/business/` для бизнес-логики**

#### 4.1: `wizard/business/parser.go`

**Ответственность:** Парсинг и обработка конфигурации

**Основные функции:**
- Парсинг ParserConfig из текста (с валидацией размера)
- Применение URL к ParserConfig (разделение подписок и connections)
- Проверка доступности URL подписок (с таймаутами и лимитами размера)
- Генерация превью outbounds

**Логика работы:**
1. Валидация размера входных данных (JSON, URI)
2. Парсинг ParserConfig из JSON строки
3. Разделение входных URL на подписки и прямые ссылки
4. Обновление структуры ParserConfig
5. Генерация превью через ConfigService
6. Обработка ошибок с контекстом для UI

**Управление ресурсами:**
- Все HTTP запросы должны использовать `context.WithTimeout`
- Обязательное закрытие `resp.Body` через `defer`
- Проверка размеров ответов перед обработкой
- Graceful shutdown для долгих операций

**Обработка ошибок:**
- Все ошибки должны возвращаться из функций (не только логироваться)
- Использование `fmt.Errorf` с `%w` для wrapping ошибок
- Структурированные ошибки с контекстом для отображения в UI

**Источник:** Функции `parseAndPreview()`, `checkURL()`, `applyURLToParserConfig()` из `ui/config_wizard.go`, дополнены валидацией и управлением ресурсами

**Зависимости:** Использует пакеты `core/config`, `core/config/parser`, `core/config/subscription`, `context` для таймаутов

#### 4.2: `wizard/business/generator.go`

**Ответственность:** Генерация финального конфига из шаблона

**Основные функции:**
- Построение конфига из шаблона и ParserConfig
- Генерация блока outbounds с маркерами
- Объединение секции route с правилами
- Форматирование JSON секций

**Логика работы:**
1. Парсинг ParserConfig и нормализация
2. Обработка выбранных секций шаблона
3. Генерация outbounds блока (или статистики для больших конфигов)
4. Объединение правил route
5. Форматирование и сборка финального JSON

**Источник:** Функции `buildTemplateConfig()`, `buildParserOutboundsBlock()`, `mergeRouteSection()` из `ui/config_wizard.go`

**Зависимости:** Использует пакеты `wizard/template` для работы с шаблонами и `wizard/utils` для утилит

#### 4.3: `wizard/business/validator.go`

**Ответственность:** Валидация данных визарда

**Основные функции:**
- Валидация ParserConfig JSON (размер, структура, версия)
- Валидация URL подписок и прямых ссылок (формат, доступность)
- Валидация правил перед сохранением (обязательные поля, формат)
- Проверка размеров данных перед обработкой (лимиты на HTTP ответы, JSON размеры)
- Валидация размеров URI перед парсингом

**Константы и лимиты:**
- Максимальный размер HTTP ответа подписки (например, 10MB)
- Максимальный размер JSON конфигурации
- Таймауты для сетевых операций
- Максимальная длина URI для парсинга

**Важно:** Все валидации должны возвращать структурированные ошибки с контекстом для отображения в UI

**Источник:** Логика валидации из различных функций `ui/config_wizard.go`, дополнена валидацией размеров и таймаутов

**Зависимости:** Использует пакеты `core/config/subscription` для проверки URL, `context` для таймаутов

#### 4.4: `wizard/business/loader.go`

**Ответственность:** Загрузка и сохранение конфигурации

**Основные функции:**
- Загрузка ParserConfig из config.json (с валидацией размера файла)
- Загрузка ParserConfig из шаблона (fallback)
- Сериализация ParserConfig в JSON
- Сохранение конфига с резервной копией
- Обеспечение обязательных outbounds из шаблона

**Логика работы:**
1. Проверка размера файла перед чтением
2. Попытка загрузки из config.json (приоритет)
3. Fallback на шаблон, если config.json отсутствует или невалиден
4. Проверка и добавление обязательных outbounds из шаблона
5. Сериализация для отображения в UI

**Управление ресурсами:**
- Все файловые операции должны использовать `defer file.Close()`
- Обработка ошибок при создании резервных копий
- Проверка доступности дискового пространства перед записью

**Обработка ошибок:**
- Все ошибки возвращаются с контекстом (путь к файлу, размер, причина)
- Структурированные ошибки для отображения в UI диалогах

**Источник:** Функции `loadConfigFromFile()`, `serializeParserConfig()`, `ensureRequiredOutbounds()`, `saveConfigWithBackup()` из `ui/config_wizard.go`, дополнены валидацией и обработкой ошибок

**Зависимости:** Использует пакеты `core/config/parser` для извлечения конфига и `wizard/template` для работы с шаблонами

---

### Шаг 5: Создать `ui/wizard/template/`

**Создать подпакет `wizard/template/` для работы с шаблонами**

#### 5.1: `wizard/template/loader.go`

**Ответственность:** Загрузка и парсинг шаблонов конфигурации

**Основные функции:**
- Загрузка шаблона из файла
- Парсинг JSONC шаблона
- Извлечение секций, правил, ParserConfig из шаблона
- Определение маркеров (@PARSER_OUTBOUNDS_BLOCK)

**Источник:** Весь файл `ui/config_template_loader.go` переносится сюда

**Зависимости:** Использует пакет `github.com/muhammadmuzzammil1998/jsonc` для парсинга JSONC

#### 5.2: `wizard/template/processor.go`

**Ответственность:** Обработка и подготовка данных шаблона

**Основные функции:**
- Инициализация состояния шаблона
- Обеспечение обязательных outbounds
- Клонирование outbounds и правил
- Управление выбранными секциями

**Источник:** Функции `initializeTemplateState()`, `ensureRequiredOutbounds()`, `cloneOutbound()`, `cloneRule()` из `ui/config_wizard.go`

**Зависимости:** Использует типы из `wizard/state` и `wizard/template/loader`

#### 5.3: `wizard/template/formatter.go`

**Ответственность:** Форматирование секций шаблона

**Основные функции:**
- Форматирование JSON секций с отступами
- Форматирование многострочного текста с отступами
- Форматирование секции route

**Источник:** Функции `formatSectionJSON()`, `indentMultiline()` из `ui/config_wizard.go`

---

### Шаг 6: Создать `ui/wizard/utils/`

**Создать подпакет `wizard/utils/` для утилит**

#### 6.1: `wizard/utils/outbound.go`

**Ответственность:** Утилиты для работы с outbounds

**Основные функции:**
- Получение списка доступных outbounds из ParserConfig
- Обеспечение значений по умолчанию для outbounds
- Выбор final outbound с учетом приоритетов
- Получение эффективного outbound для правил

**Источник:** Функции `getAvailableOutbounds()`, `ensureDefaultOutbound()`, `ensureDefaultAvailableOutbounds()`, `ensureFinalSelected()`, `getEffectiveOutbound()` из `ui/config_wizard.go`

#### 6.2: `wizard/utils/preview.go`

**Ответственность:** Утилиты для работы с превью

**Основные функции:**
- Установка текста превью outbounds
- Установка текста превью шаблона
- Асинхронное обновление превью шаблона
- Триггер парсинга для превью

**Источник:** Функции `setPreviewText()`, `setTemplatePreviewText()`, `updateTemplatePreviewAsync()`, `triggerParseForPreview()` из `ui/config_wizard.go`

#### 6.3: `wizard/utils/navigation.go`

**Ответственность:** Утилиты для навигации по визарду

**Основные функции:**
- Обновление кнопок навигации в зависимости от вкладки
- Обновление вкладки правил
- Обновление опций outbound в селекторах

**Источник:** Функции `updateNavigationButtons()`, `refreshRulesTab()`, `refreshOutboundOptions()` из `ui/config_wizard.go`

#### 6.4: `wizard/utils/comparison.go`

**Ответственность:** Утилиты для сравнения структур

**Основные функции:**
- Строгое сравнение outbounds
- Сравнение слайсов строк
- Глубокое сравнение map
- Сравнение значений (рекурсивно)

**Источник:** Функции `outboundsMatchStrict()`, `stringSlicesEqual()`, `mapsEqual()`, `valuesEqual()` из `ui/config_wizard.go`

#### 6.5: `wizard/utils/constants.go`

**Ответственность:** Константы и лимиты для визарда

**Содержимое:**
- Таймауты: `HTTPRequestTimeout`, `SubscriptionFetchTimeout`, `URIParseTimeout`
- Лимиты размеров: `MaxSubscriptionSize`, `MaxJSONConfigSize`, `MaxURILength`, `MaxNodesForFullPreview`
- UI константы: `WizardWindowWidth`, `WizardWindowHeight`, `PreviewTextThreshold`
- Константы для валидации: `MinURILength`, `MaxPreviewLines`

**Важно:** Все магические числа из кода должны быть вынесены в этот файл с документацией причины выбора значения

**Источник:** Магические числа из различных функций `ui/config_wizard.go`, дополнены недостающими лимитами согласно CODE_INSPECTION_REPORT.md #5 и #11

---

### Шаг 7: Создать `ui/wizard/wizard.go`

**Ответственность:** Точка входа и координация визарда

**Основные функции:**
- Инициализация визарда (ShowConfigWizard)
- Создание окна и вкладок
- Координация навигации между шагами
- Управление жизненным циклом визарда

**Логика работы:**
1. Создание состояния визарда
2. Загрузка шаблона
3. Загрузка конфига из файла или шаблона
4. Создание UI компонентов (вкладки, кнопки навигации)
5. Настройка обработчиков событий
6. Отображение окна

**Источник:** Функция `ShowConfigWizard()` и логика инициализации из `ui/config_wizard.go`

**Зависимости:** Использует все подпакеты `wizard/` для координации работы

---

### Шаг 8: Обновить тесты

**Действия:**
- Переместить тесты в соответствующие директории новой структуры
- Обновить все импорты на новые пути пакетов
- Адаптировать вызовы функций под новую архитектуру
- Убедиться, что все тесты используют правильные пакеты

**Источник:** `ui/config_wizard_test.go` обновляется для использования новых пакетов

---

### Шаг 9: Обновить все импорты

**Особое внимание:**
- Все места использования `ui.ShowConfigWizard()` должны импортировать `ui/wizard`
- Все места использования типов `WizardState`, `SelectableRuleState` должны импортировать `ui/wizard/state`
- Все внутренние вызовы функций должны использовать новые пути пакетов

**Области обновления:**

1. **В `ui/` пакете:**
   - Основные файлы UI (app.go, core_dashboard_tab.go) должны импортировать `ui/wizard` для вызова визарда
   - Все ссылки на старые функции и типы должны быть заменены на новые пути

2. **В тестах:**
   - Все тесты должны быть обновлены с новыми путями импортов
   - Тесты должны использовать прямые импорты из соответствующих подпакетов

---

### Шаг 10: Удалить устаревшие файлы

**Файлы к удалению:**
- `ui/config_wizard.go` (содержимое распределено по `wizard/`)
- `ui/config_wizard_state.go` (содержимое в `wizard/state/`)
- `ui/config_wizard_rule_dialog.go` (содержимое в `wizard/dialogs/`)
- `ui/config_template_loader.go` (содержимое в `wizard/template/`)

**ВАЖНО:**
- Все функции и типы должны быть доступны через новые пакеты
- Не создавать wrapper-функций для обратной совместимости
- Все места использования должны быть обновлены на прямые импорты

---

## Обновление тестов

**Действия:**
- Переместить тесты в соответствующие директории новой структуры
- Обновить все импорты на новые пути пакетов
- Адаптировать вызовы функций под новую архитектуру (обновить сигнатуры, убрать ресиверы где необходимо)
- Убедиться, что все тесты используют правильные пакеты из новой структуры

**Недостающее покрытие тестами (см. CODE_INSPECTION_REPORT.md #6):**

1. **Тесты для бизнес-логики:**
   - `wizard/business/parser.go` - тесты парсинга, валидации размеров, таймаутов
   - `wizard/business/generator.go` - тесты генерации конфига, обработки шаблонов
   - `wizard/business/validator.go` - тесты всех видов валидации
   - `wizard/business/loader.go` - тесты загрузки и сохранения конфигов

2. **Интеграционные тесты:**
   - Полный цикл работы визарда (открытие, заполнение, сохранение)
   - Обработка ошибок сети и парсинга
   - Тесты с большими конфигурациями (проверка лимитов)

3. **Table-driven tests:**
   - Тесты валидации для граничных случаев
   - Тесты парсинга различных форматов URL
   - Тесты обработки ошибок

4. **Тесты управления ресурсами:**
   - Проверка закрытия файлов и HTTP соединений
   - Тесты таймаутов и отмены операций
   - Тесты graceful shutdown

---

## Проверка после рефакторинга

**Этапы проверки:**
1. Успешная компиляция всего проекта
2. Запуск всех тестов во всех затронутых пакетах
3. Статический анализ кода (go vet)
4. Проверка корректности импортов
5. Проверка отсутствия циклических зависимостей

**Функциональная проверка:**
- Открытие визарда работает корректно
- Загрузка конфига из файла выполняется без ошибок
- Загрузка конфига из шаблона работает корректно
- Парсинг и генерация превью обрабатывает все типы ссылок
- Сохранение конфига создаёт валидный вывод
- Навигация между вкладками работает корректно
- Диалоги правил открываются и сохраняют данные
- Все существующие тесты проходят успешно

---

## Риски и ограничения

1. **Циклические зависимости**: 
   - `wizard/business` импортирует `core/config` - это нормально
   - `wizard/tabs` импортирует `wizard/state` - это нормально
   - `wizard/business` может импортировать `wizard/utils` - это нормально
   - Проверить, что нет циклов типа `wizard/business` → `wizard/tabs` → `wizard/business`

2. **Публичный API**: 
   - `ShowConfigWizard()` остается публичной функцией в пакете `ui/wizard`
   - Типы состояния доступны через `ui/wizard/state`
   - Внутренние функции могут быть неэкспортируемыми (lowercase)

3. **Тесты**: 
   - Все тесты нужно обновить для новых импортов
   - Убедиться, что все функции доступны для тестирования
   - Возможно, потребуется экспортировать некоторые внутренние функции для тестирования

4. **Fyne зависимости**: 
   - Все UI компоненты зависят от Fyne
   - Бизнес-логика не должна напрямую зависеть от Fyne (только через интерфейсы или callbacks)

5. **Унификация комментариев**: 
   - Все новые комментарии должны быть на английском языке (см. CODE_INSPECTION_REPORT.md #4)
   - Существующие русские комментарии постепенно переводятся на английский
   - Godoc комментарии для всех экспортируемых функций

6. **Управление ресурсами**: 
   - Все файловые операции должны использовать `defer file.Close()`
   - Все HTTP запросы должны закрывать `resp.Body` через `defer`
   - Использование `context.WithTimeout` для всех сетевых операций
   - Проверка размеров данных перед обработкой (см. CODE_INSPECTION_REPORT.md #7)

7. **Обработка ошибок**: 
   - Все ошибки должны возвращаться из функций (не только логироваться)
   - Использование `fmt.Errorf` с `%w` для wrapping ошибок
   - Структурированные ошибки с контекстом для UI
   - Использование `errors.Is` и `errors.As` для проверки типов ошибок (см. CODE_INSPECTION_REPORT.md #8)

---

## Зависимости между модулями

**Иерархия зависимостей:**
- `ui/wizard/` - основной пакет визарда
  - `wizard.go` - точка входа, координирует все модули
  - `state/` - базовые типы состояния (не зависит от других модулей wizard)
  - `tabs/` - UI компоненты вкладок (зависит от `state/`, `dialogs/`, `business/`)
  - `dialogs/` - диалоги (зависит от `state/`)
  - `business/` - бизнес-логика (зависит от `state/`, `template/`, `utils/`, `core/config`)
  - `template/` - работа с шаблонами (зависит от `state/`)
  - `utils/` - утилиты (зависит от `state/`)

**Важно:** Циклических зависимостей нет. Все зависимости идут в одном направлении от низкоуровневых утилит к высокоуровневым компонентам.

---

## Примечания

- **Разделение ответственности** - UI компоненты отделены от бизнес-логики
- **Модульность** - каждый шаг визарда может быть расширен или изменен независимо
- **Тестируемость** - бизнес-логика может быть протестирована без UI компонентов
- **Поддерживаемость** - четкая структура упрощает навигацию и понимание кода
- **Учет рекомендаций инспекции** - план учитывает все критические проблемы из CODE_INSPECTION_REPORT.md:
  - Валидация входных данных (#5)
  - Обработка ошибок (#8)
  - Управление ресурсами (#7)
  - Унификация комментариев (#4)
  - Вынос констант (#11)
  - Улучшение тестов (#6)
- Изменения только в организации кода и структуре импортов, функциональность не меняется
- Агент самостоятельно определяет конкретные замены импортов на основе структуры пакетов и их содержимого

## Связь с CODE_INSPECTION_REPORT.md

Этот план рефакторинга напрямую решает следующие проблемы из отчета инспекции:

- **#2 (Критично)**: Разбиение монолитного `config_wizard.go` (2284 строки) на модульную структуру
- **#5 (Средне)**: Добавление валидации входных данных в `wizard/business/validator.go`
- **#7 (Средне)**: Управление ресурсами (defer, context) во всех бизнес-функциях
- **#8 (Средне)**: Унифицированная обработка ошибок с возвратом и контекстом
- **#4 (Средне)**: Унификация комментариев на английском языке
- **#11 (Низко)**: Вынос всех магических чисел в `wizard/utils/constants.go`
- **#6 (Средне)**: Расширенное покрытие тестами с интеграционными и table-driven тестами
- **#9 (Низко)**: Устранение дублирования кода через переиспользуемые утилиты

