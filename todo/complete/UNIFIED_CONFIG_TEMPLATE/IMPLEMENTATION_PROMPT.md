# Промпт реализации: Единый config_template.json

Реализуй задачу согласно `SPEC.md`. Схема данных — в `JSON_SCHEMA.md`. Эталонный шаблон — `config_template.json`.

---

## Главные принципы

### 1. Обратная совместимость — только функциональная

**НЕ сохраняй обратную совместимость на уровне API (сигнатуры функций, типы, интерфейсы).**

- Старые типы (`Sections map[string]json.RawMessage`, `SectionOrder []string`, `ParserConfig string`) — удаляй, не оборачивай
- Старые функции парсинга комментариев (`extractCommentBlock`, `parseSelectableRules`, и т.д.) — удаляй полностью
- Интерфейсы, которые существовали только ради старого формата — удаляй
- Если вызывающий код ломается — **исправь вызывающий код**, а не создавай обёртку

**Сохраняй обратную совместимость на уровне функциональности:**

- Визард загружает шаблон, показывает правила, генерирует конфиг, сохраняет — всё работает как раньше
- `state.json` старого формата корректно мигрируется при загрузке
- Существующий `config.json` продолжает работать с `parser.ExtractParserConfig()`
- Автообновление, запуск sing-box, tray-меню — не затрагиваются

### 2. Никаких лишних обёрток

- **Не создавай адаптеры, прокси, фасады** без реальной необходимости
- Если функция может вызываться напрямую — вызывай напрямую
- Если интерфейс нужен только в одном месте и у него одна реализация — не нужен интерфейс, используй конкретный тип
- Если обёртка только пробрасывает вызов без логики — удали обёртку
- `type XxxAdapter struct { inner *Xxx }` с методами-однострочниками — антипаттерн; допустим только если нужен для тестирования (мок)

### 3. Чистый код

- Функции короткие, с одной ответственностью
- Early returns вместо вложенных if/else
- Нет мёртвого кода, нет закомментированного кода
- Нет неиспользуемых импортов и переменных
- Константы вместо магических строк и чисел
- `defer` для всех ресурсов

### 4. Комментарии на русском

- Все комментарии к функциям, типам, полям структур — **на русском языке**
- Go-стиль: `// FunctionName описание функции`
- Комментируй **почему**, а не **что**
- Пакетные комментарии (`// Package xxx ...`) — на русском

```go
// LoadTemplateData загружает единый шаблон и применяет платформозависимые params.
// Фильтрация selectable_rules по platforms происходит до маппинга с state.json.
func LoadTemplateData(templatePath string) (*TemplateData, error) {
```

### 5. Обработка ошибок

- `fmt.Errorf("контекст: %w", err)` — оборачивай с контекстом
- Не глотай ошибки молча
- Логируй через `debuglog` (не `log`)
- Уровни: `ErrorLog` для ошибок, `WarnLog` для предупреждений, `DebugLog` для отладки

### 6. Структуры данных

- Новые структуры (`UnifiedTemplate`, обновлённый `TemplateData`, `TemplateSelectableRule`) — с русскими комментариями на каждом поле
- Не дублируй данные шаблона в state — state хранит только `{ label, enabled, selected_outbound }`
- JSON-теги обязательны для всех полей, участвующих в сериализации

```go
// UnifiedTemplate — корневая структура единого шаблона.
type UnifiedTemplate struct {
	// ParserConfig — конфигурация парсера подписок.
	ParserConfig json.RawMessage `json:"parser_config"`
	// Config — основной конфиг sing-box (платформонезависимая часть).
	Config json.RawMessage `json:"config"`
	// SelectableRules — правила маршрутизации для визарда.
	SelectableRules []SelectableRule `json:"selectable_rules"`
	// Params — платформозависимые параметры, применяемые к Config.
	Params []Param `json:"params"`
}
```

---

## Что удалять без сожалений

| Категория | Примеры |
|-----------|---------|
| Парсинг комментариев | `extractCommentBlock`, `extractAllSelectableBlocks`, `parseSelectableRules`, `extractRuleMetadata`, `normalizeRuleJSON`, `extractOutboundsAfterMarker` |
| Платформозависимый выбор файла | `GetTemplateFileName()` if/else по GOOS, `GetTemplateURL()` if/else по GOOS |
| Нормализация process_name | `cloneRule()`, `normalizeProcessNames()` |
| Маркеры в комментариях | Всё, что связано с `@ParserConfig`, `@SelectableRule`, `@PARSER_OUTBOUNDS_BLOCK` |
| Второй файл шаблона | `bin/config_template_macos.json` |
| Обёртки без логики | Адаптеры, пробрасывающие вызовы 1:1 |

---

## Что НЕ трогать

- `core/services/file_service.go` — бэкапы, логи, пути
- `core/controller.go` — запуск/остановка sing-box, tray-меню
- `core/auto_update.go` — автообновление
- `api/` — Clash API, прокси
- `internal/debuglog/` — логирование
- `internal/platform/` — платформозависимый код (кроме удаления `GetRequiredFiles` если ещё не удалён)

---

## Порядок реализации

1. Новые структуры данных (`UnifiedTemplate`, обновлённый `TemplateData`, `SelectableRule`, `Param`)
2. Загрузчик шаблона (`LoadTemplateData`) — чтение, unmarshal, применение params, фильтрация по platforms
3. Генератор конфига — работа с `Config` объектом вместо `Sections`
4. Миграция `state.json` — поддержка старого формата при загрузке
5. Удаление старого кода — парсинг комментариев, второй шаблон, обёртки
6. Обновление тестов

---

## Порядок финальной проверки

### 1. Тесты — переписать до запуска сборки

Часть существующих тестов завязана на старую логику (парсинг комментариев, `Sections`, `ParserConfig string`, два файла шаблонов). **Перед запуском сборки** — пройди по тестам и обнови/перепиши те, которые зависели от удалённого кода:

- Тесты парсинга `@SelectableRule`, `@ParserConfig` блоков — удалить
- Тесты `extractCommentBlock`, `parseSelectableRules`, `normalizeRuleJSON` и т.д. — удалить
- Тесты загрузки шаблона (`LoadTemplateData`) — переписать под новую структуру `UnifiedTemplate`
- Тесты генерации конфига — обновить: `Config` объект вместо `Sections`
- Тесты `state.json` — добавить кейс миграции со старого формата
- Тесты `cloneRule`, `normalizeProcessNames` — удалить

### 2. Проверки

```
go vet ./...
go test ./...
.\build\build_windows.bat
```

Убедиться что:
- `go vet` проходит без ошибок
- Все тесты проходят (в том числе переписанные)
- Проект **собирается** через `.\build\build_windows.bat` — финальная проверка что всё компилируется в реальной сборке

### 3. Ручная проверка

- Загрузка визарда — шаблон читается, правила отображаются
- Включение/выключение selectable rules — работает
- Генерация конфига — корректный JSON
- Сохранение — бэкап + запись
- Миграция старого `state.json` — правила сопоставляются по `label`

---

## Контракт выхода

После завершения:

1. **Список изменённых/удалённых файлов** с кратким описанием
2. **Ключевые фрагменты** — только существенные изменения
3. **Результаты проверок** — `go vet`, `go test`, `.\build\build_windows.bat`
4. **Что проверить вручную** — загрузка визарда, правила, генерация, сохранение, миграция
5. **Assumptions** — если пришлось додумывать

