# План логики скачивания последней версии sing-box

## Обзор
Документ описывает подробный план реализации функционала автоматического скачивания и обновления sing-box core из GitHub releases.

## 1. Получение информации о последней версии

### 1.1. Источник данных
- **GitHub API**: `https://api.github.com/repos/SagerNet/sing-box/releases/latest`
- **Формат ответа**: JSON с полем `tag_name` (например, "v1.12.12")
- **Альтернативный источник**: Парсинг HTML страницы releases (если API недоступен)

### 1.2. Реализация
```go
type ReleaseInfo struct {
    TagName     string `json:"tag_name"`
    PublishedAt string `json:"published_at"`
    Assets      []Asset `json:"assets"`
}

type Asset struct {
    Name               string `json:"name"`
    BrowserDownloadURL string `json:"browser_download_url"`
    Size               int64  `json:"size"`
}
```

### 1.3. Обработка ошибок
- HTTP 403/429: Использовать прокси через sing-box (если запущен) или показать ошибку
- Таймаут: 10 секунд для HTTP запроса
- Парсинг: Валидация формата версии (X.Y.Z)

## 2. Определение платформы и архитектуры

### 2.1. Платформы
- **Windows**: `windows-amd64.zip` или `windows-arm64.zip`
- **Linux**: `linux-amd64.tar.gz`, `linux-arm64.tar.gz`, `linux-armv7.tar.gz`
- **macOS**: `darwin-amd64.tar.gz` или `darwin-arm64.tar.gz`

### 2.2. Определение архитектуры
```go
func getPlatformAsset(assets []Asset) (*Asset, error) {
    goos := runtime.GOOS
    goarch := runtime.GOARCH
    
    // Маппинг: GOOS/GOARCH -> имя файла
    // windows/amd64 -> windows-amd64.zip
    // linux/arm64 -> linux-arm64.tar.gz
    // darwin/arm64 -> darwin-arm64.tar.gz
}
```

### 2.3. Валидация
- Проверка наличия подходящего asset
- Проверка размера файла (не должен быть 0)
- Проверка формата архива (.zip для Windows, .tar.gz для Unix)

## 3. Процесс скачивания

### 3.1. Подготовка
1. Проверка наличия интернет-соединения
2. Проверка доступного места на диске (минимум размер файла * 2)
3. Создание временной директории для загрузки

### 3.2. HTTP клиент
```go
client := &http.Client{
    Timeout: 30 * time.Second, // Таймаут на весь запрос
    Transport: &http.Transport{
        Proxy: getProxyIfAvailable(), // Использовать прокси если sing-box запущен
        TLSClientConfig: &tls.Config{},
    },
}
```

### 3.3. Прогресс скачивания
- Использовать `io.Copy` с `io.TeeReader` для отслеживания прогресса
- Отправлять обновления через канал: `chan UpdateProgress`
- Формат прогресса: `{Progress: 0-100, Message: string, Status: "downloading"|"extracting"|"done"|"error"}`

### 3.4. Обработка ошибок
- Прерванное соединение: Повторная попытка (до 3 раз)
- Недостаточно места: Показать ошибку пользователю
- Неверный формат архива: Показать ошибку

## 4. Распаковка архива

### 4.1. Windows (.zip)
```go
import "archive/zip"

func extractZip(src, dst string) error {
    r, err := zip.OpenReader(src)
    // Найти sing-box.exe в архиве
    // Скопировать в целевую директорию
}
```

### 4.2. Unix (.tar.gz)
```go
import (
    "archive/tar"
    "compress/gzip"
)

func extractTarGz(src, dst string) error {
    // Распаковать .tar.gz
    // Найти sing-box в архиве
    // Скопировать в целевую директорию
}
```

### 4.3. Поиск бинарника в архиве
- Искать файл с именем `sing-box` или `sing-box.exe`
- Игнорировать другие файлы (README, LICENSE и т.д.)

## 5. Атомарная замена бинарника

### 5.1. Стратегия замены
1. **Остановить sing-box** (если запущен)
2. **Переименовать старый бинарник**: `sing-box.exe` -> `sing-box.exe.old`
3. **Скопировать новый бинарник** в целевую директорию
4. **Установить права доступа** (для Unix: `chmod 0755`)
5. **Проверить целостность**: Запустить `sing-box version` для проверки
6. **Удалить старый бинарник**: Удалить `.old` файл после успешной проверки

### 5.2. Откат при ошибке
- Если проверка не прошла: Восстановить старый бинарник из `.old`
- Если новый бинарник поврежден: Восстановить старый
- Логировать все операции для отладки

### 5.3. Кросс-платформенность
```go
func replaceBinary(oldPath, newPath string) error {
    // Windows: Простое переименование
    // Unix: Требуются права на запись
    // Проверка прав доступа перед заменой
}
```

## 6. UI интеграция

### 6.1. Кнопка обновления
- **Текст**: "Update Core → v1.12.13" (если есть обновление)
- **Цвет**: Синий (HighImportance) если есть обновление
- **Состояние**: Disabled во время обновления

### 6.2. Прогресс-бар
- Показывать во время скачивания и распаковки
- Обновлять в реальном времени (0-100%)
- Скрывать после завершения

### 6.3. Уведомления
- **Начало**: "Downloading sing-box v1.12.13..."
- **Прогресс**: "Downloading: 45% (12.5 MB / 27.8 MB)"
- **Завершение**: "Update complete! New version: 1.12.13"
- **Ошибка**: Показать диалог с описанием ошибки

### 6.4. Автоматическая проверка обновлений
- Проверять каждые 12 секунд (как сейчас)
- Не блокировать UI (выполнять в горутине)
- Кэшировать результат на 5 минут (чтобы не спамить GitHub API)

## 7. Безопасность

### 7.1. Проверка целостности
- **Хеш-сумма**: GitHub предоставляет SHA256 для каждого asset
- **Проверка подписи**: Если доступна, проверить GPG подпись
- **Валидация версии**: После распаковки запустить `sing-box version` и сравнить

### 7.2. Обработка прав доступа
- **Windows**: Может потребоваться запуск от администратора для замены бинарника
- **Unix**: Проверить права на запись в `bin/` директорию
- **Показ предупреждения**: Если прав недостаточно, показать инструкцию

## 8. Оптимизации

### 8.1. Кэширование
- Кэшировать информацию о последней версии на 5 минут
- Не проверять обновления чаще чем раз в минуту

### 8.2. Прокси
- Если sing-box запущен, использовать его как прокси для GitHub API
- Это решает проблему с блокировкой GitHub в некоторых регионах

### 8.3. Фоновая загрузка
- Скачивать обновление в фоне, показывать уведомление когда готово
- Пользователь может продолжить работу, обновление применится при следующем запуске

## 9. Обработка edge cases

### 9.1. Sing-box запущен во время обновления
- Показать диалог: "Sing-box is running. Stop it to update?"
- Если пользователь согласен, остановить, обновить, запустить снова

### 9.2. Несколько экземпляров launcher
- Проверить, не запущен ли другой экземпляр
- Заблокировать обновление если другой экземпляр использует бинарник

### 9.3. Недостаточно места
- Проверить доступное место перед скачиванием
- Показать понятное сообщение об ошибке

### 9.4. Прерванное обновление
- Сохранить состояние обновления (версия, прогресс)
- При следующем запуске предложить продолжить или откатить

## 10. Логирование

### 10.1. События для логирования
- Начало проверки обновлений
- Найденная последняя версия
- Начало скачивания
- Прогресс скачивания (каждые 10%)
- Завершение скачивания
- Начало распаковки
- Завершение распаковки
- Замена бинарника
- Проверка новой версии
- Ошибки на каждом этапе

### 10.2. Формат логов
```
[UPDATE] Checking for updates...
[UPDATE] Latest version: 1.12.13 (current: 1.12.12)
[UPDATE] Downloading sing-box-windows-amd64.zip (27.8 MB)
[UPDATE] Download progress: 45% (12.5 MB / 27.8 MB)
[UPDATE] Download complete
[UPDATE] Extracting archive...
[UPDATE] Binary extracted successfully
[UPDATE] Replacing old binary...
[UPDATE] Update complete: 1.12.12 -> 1.12.13
```

## 11. Тестирование

### 11.1. Сценарии тестирования
1. Обновление когда sing-box не запущен
2. Обновление когда sing-box запущен (требуется остановка)
3. Обновление когда нет интернета
4. Обновление когда GitHub API недоступен
5. Обновление когда недостаточно места
6. Прерванное скачивание (симуляция)
7. Поврежденный архив
8. Неверная версия в архиве
9. Недостаточно прав для замены бинарника

### 11.2. Автоматические тесты
- Unit тесты для парсинга версий
- Unit тесты для определения платформы
- Integration тесты для скачивания (с мок-сервером)
- Integration тесты для распаковки

## 12. Реализация по этапам

### Этап 1: Базовая функциональность
1. Получение информации о последней версии через GitHub API
2. Определение платформы и выбор правильного asset
3. Простое скачивание без прогресса

### Этап 2: UI интеграция
1. Кнопка обновления в Core Dashboard
2. Прогресс-бар
3. Уведомления

### Этап 3: Надежность
1. Атомарная замена бинарника
2. Откат при ошибке
3. Проверка целостности

### Этап 4: Оптимизации
1. Кэширование
2. Использование прокси
3. Фоновая загрузка

### Этап 5: Полировка
1. Обработка всех edge cases
2. Улучшенное логирование
3. Тестирование

## Заключение

Этот план обеспечивает надежное и безопасное обновление sing-box core с учетом всех возможных сценариев и ошибок. Реализация должна быть поэтапной, с тестированием на каждом этапе.

