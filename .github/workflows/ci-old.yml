name: CI/CD

# ==============================================================================
# CI/CD Workflow Usage
#
# This workflow supports three explicit scenarios:
#
# 1) Stable Release (manual tag)
# ------------------------------------------------------------------------------
# Create and push a version tag manually:
#   git tag v0.6.1
#   git push origin v0.6.1
#
# Result:
# - Workflow is triggered by the tag
# - Full build is executed
# - GitHub Release is created (draft)
# - Release artifacts are attached
# - prerelease = false
#
# 2) Pre-release (manual trigger)
# ------------------------------------------------------------------------------
# gh workflow run ci.yml --ref develop \
#   -f run_mode=prerelease \
#   -f skip_tests=true
#
# Result:
# - Version/tag generated automatically:
#   v.dev.<branch>.<sha7>
# - Tag is created and pushed by workflow
# - GitHub Pre-release is created (draft)
# - prerelease = true
#
# 3) Build only (no release, no tag)
# ------------------------------------------------------------------------------
# gh workflow run ci.yml --ref develop \
#   -f run_mode=build \
#   -f skip_tests=true
#
# Result:
# - Build artifacts are produced and uploaded
# - No git tag is created
# - No GitHub Release is created
#
# Notes:
# - push to main → tests only
# - pull requests → tests only
# - workflow_dispatch controls manual behaviors
# - No automatic tagging happens except prereleases
#
# NOTE:
# Tags with prefix v.dev.* are CI-generated and should not be used as stable releases.
# ==============================================================================

on:
  push:
    branches: [ main ]
    tags:
      - "v*"
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      run_mode:
        description: "tests | build | prerelease"
        required: true
        default: "tests"
        type: choice
        options: [ tests, build, prerelease ]
      skip_tests:
        description: "Skip tests (only for build/prerelease)"
        required: false
        default: false
        type: boolean
      target:
        description: "Which build to run: all|win7|win64"
        required: false
        default: "all"
        type: choice
        options: [ all, win7, win64 ]

# Default permission: read-only. Release job overrides to contents: write.
permissions:
  contents: read

jobs:
  meta:
    name: Meta
    if: startsWith(github.ref, 'refs/tags/v') ||
        (github.event_name == 'workflow_dispatch' &&
          (github.event.inputs.run_mode == 'build' || github.event.inputs.run_mode == 'prerelease'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      prerelease: ${{ steps.meta.outputs.prerelease }}
      channel: ${{ steps.meta.outputs.channel }}
      tag: ${{ steps.meta.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute version and channel
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          # Stable tag trigger
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "channel=release" >> "$GITHUB_OUTPUT"
            echo "tag=$VERSION" >> "$GITHUB_OUTPUT"
            echo "Version: $VERSION"
            exit 0
          fi

          RUN_MODE="${{ github.event.inputs.run_mode }}"
          SHORT_SHA="$(git rev-parse --short=7 HEAD)"

          BRANCH_RAW="${GITHUB_REF_NAME}"
          BRANCH_SANITIZED="$(echo "$BRANCH_RAW" | tr '/ ' '--' | sed -E 's/[^A-Za-z0-9._-]+/-/g')"

          DEV_TAG="v.dev.${BRANCH_SANITIZED}.${SHORT_SHA}"

          if [[ "$RUN_MODE" == "prerelease" ]]; then
            echo "version=$DEV_TAG" >> "$GITHUB_OUTPUT"
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
            echo "channel=prerelease" >> "$GITHUB_OUTPUT"
            echo "tag=$DEV_TAG" >> "$GITHUB_OUTPUT"
            echo "Version: $DEV_TAG"
            echo "Channel: prerelease"
          else
            VERSION="dev.${BRANCH_SANITIZED}.${SHORT_SHA}"
            echo "version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "channel=build" >> "$GITHUB_OUTPUT"
            echo "tag=" >> "$GITHUB_OUTPUT"
            echo "Version: $VERSION"
            echo "Channel: build"
          fi

  test:
    name: Test
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main')
      || (github.event_name == 'pull_request')
      || (github.event_name == 'workflow_dispatch' &&
          (github.event.inputs.run_mode == 'tests' ||
           ((github.event.inputs.run_mode == 'build' || github.event.inputs.run_mode == 'prerelease')
             && github.event.inputs.skip_tests != 'true')))
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install build dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev libgtk-3-dev

      - name: Verify C compiler (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        continue-on-error: true
        run: |
          gcc --version || echo GCC check failed, but continuing...

      - name: Install dependencies
        run: go mod download

      - name: Clean previous coverage files (Linux/macOS)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: |
          rm -f coverage.out coverage.txt coverage.html || true

      - name: Clean previous coverage files (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        run: |
          if exist coverage.out del /q coverage.out
          if exist coverage.txt del /q coverage.txt
          if exist coverage.html del /q coverage.html

      - name: Run tests (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        env:
          CGO_ENABLED: 1
        shell: bash
        run: |
          bash build/test_linux.sh nopause

      - name: Run tests (macOS)
        if: matrix.os == 'macos-latest'
        env:
          CGO_ENABLED: 1
        shell: bash
        run: |
          bash build/test_darwin.sh nopause

      - name: Run tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: cmd
        env:
          CGO_ENABLED: 1
        run: |
          echo === Verifying coverage files are cleaned ===
          if exist coverage.out (echo ERROR: coverage.out still exists && exit /b 1)
          if exist coverage.txt (echo ERROR: coverage.txt still exists && exit /b 1)
          if exist coverage.html (echo ERROR: coverage.html still exists && exit /b 1)
          echo Coverage files cleaned successfully
          echo.
          echo === Running tests via build script ===
          call build\test_windows.bat nopause

      - name: Upload coverage (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

      - name: Check go mod tidy is clean (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          set -euo pipefail

          echo "Running go mod tidy check..."
          go mod tidy

          if ! git diff --exit-code; then
            echo ""
            echo "❌ go.mod / go.sum are not tidy"
            echo ""
            echo "Please run locally:"
            echo "  go mod tidy"
            echo "  git commit -am \"go mod tidy\""
            echo ""
            echo "Diff:"
            git diff
            exit 1
          fi

          echo "✅ go.mod and go.sum are tidy"

  build:
    name: Build ${{ matrix.goos }}
    if: startsWith(github.ref, 'refs/tags/v') ||
        (github.event_name == 'workflow_dispatch' &&
          ( (github.event.inputs.run_mode == 'build' || github.event.inputs.run_mode == 'prerelease') && (github.event.inputs.target == 'all' || github.event.inputs.target == 'win64') ))
    needs: meta
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            goos: darwin
            goarch: universal
          - os: windows-latest
            goos: windows
            goarch: amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Export version and channel
        shell: bash
        run: |
          echo "Version: ${{ needs.meta.outputs.version }}"
          echo "Channel: ${{ needs.meta.outputs.channel }}"

      - name: Install dependencies
        run: go mod download

      - name: Verify C compiler (macOS)
        if: matrix.goos == 'darwin'
        shell: bash
        continue-on-error: true
        run: |
          clang --version || echo "Warning: clang check failed, but continuing..."
          xcrun --show-sdk-path || echo "Warning: xcrun check failed, but continuing..."

      - name: Verify C compiler (Windows)
        if: matrix.goos == 'windows'
        shell: cmd
        continue-on-error: true
        run: |
          gcc --version || echo GCC check failed, but continuing...

      - name: Build macOS .app bundle (Universal)
        if: matrix.goos == 'darwin'
        shell: bash
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          APP_VERSION: ${{ needs.meta.outputs.version }}
        run: |
          chmod +x build/build_darwin.sh
          build/build_darwin.sh universal
          mkdir -p dist
          mv -f singbox-launcher.app dist/

      - name: Build macOS .app bundle (Catalina target, Intel-only)
        if: matrix.goos == 'darwin' && matrix.os == 'macos-latest'
        shell: bash
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          APP_VERSION: ${{ needs.meta.outputs.version }}
        run: |
          chmod +x build/build_darwin.sh
          build/build_darwin.sh catalina
          mkdir -p dist
          # Rename to avoid clobbering universal build
          if [ -d "singbox-launcher.app" ]; then
            mv -f singbox-launcher.app dist/singbox-launcher-macos-catalina.app
          else
            echo "Warning: catalina build did not produce singbox-launcher.app"
          fi

      - name: Upload Catalina artifacts (macOS)
        if: matrix.goos == 'darwin' && matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-macos-catalina
          path: |
            dist/singbox-launcher-macos-catalina.app
            dist/singbox-launcher-macos-catalina.zip
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 1 || 30 }}

      - name: Install rsrc (Windows)
        if: matrix.goos == 'windows'
        shell: cmd
        run: |
          go install github.com/akavel/rsrc@latest
          for /f "delims=" %%g in ('go env GOPATH') do echo rsrc installed to: %%g\bin

      - name: Build Windows .exe
        if: matrix.goos == 'windows'
        shell: cmd
        env:
          CGO_ENABLED: 1
          GOOS: windows
          GOARCH: amd64
          APP_VERSION: ${{ needs.meta.outputs.version }}
        run: |
          call build\build_windows.bat silent
          if not exist dist mkdir dist
          move /y singbox-launcher.exe dist\singbox-launcher.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.goos }}
          path: dist/*
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 1 || 30 }}

  build-win7:
    name: Build Windows 7 (x86, legacy)
    if: startsWith(github.ref, 'refs/tags/v') ||
        (github.event_name == 'workflow_dispatch' &&
          ( (github.event.inputs.run_mode == 'build' || github.event.inputs.run_mode == 'prerelease')
            && (github.event.inputs.target == 'all' || github.event.inputs.target == 'win7') ))
    needs: meta
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Go (legacy)
        uses: actions/setup-go@v5
        with:
          go-version: '1.20.14'
          cache: true

      - name: Show version info
        shell: bash
        run: |
          echo "Version: ${{ needs.meta.outputs.version }}"
          echo "Channel: ${{ needs.meta.outputs.channel }}"

      - name: Patch go.mod to Go 1.20
        shell: pwsh
        run: |
          Copy-Item -Force go.mod go.mod.orig
          (Get-Content go.mod) -replace 'go\s+[0-9]+\.[0-9]+(\.[0-9]+)?','go 1.20' | Set-Content go.mod

      - name: Download dependencies
        run: go mod download

      # MSYS2 нужен ТОЛЬКО для сборки
      - name: Setup MSYS2 (MINGW32)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW32
          update: true
          install: |
            mingw-w64-i686-toolchain
            mingw-w64-i686-pkgconf
            base-devel
            git

      - name: Build Windows 7 x86 (Fyne +rsrc@fixed)
        shell: msys2 {0}
        env:
          GOOS: windows
          GOARCH: 386
          CGO_ENABLED: 1
          APP_VERSION: ${{ needs.meta.outputs.version }}
        run: |
          set -e

          export GOOS=windows
          export GOARCH=386
          export CGO_ENABLED=1

          export PATH="/c/hostedtoolcache/windows/go/1.20.14/x64/bin:$PATH"
          export PATH="/mingw32/bin:$PATH"
          export GOPATH_MSYS="$(cygpath -u "$(go env GOPATH)")"
          export PATH="$GOPATH_MSYS/bin/${GOOS}_${GOARCH}:$PATH"
          export PATH="$GOPATH_MSYS/bin:$PATH"

          export CC=i686-w64-mingw32-gcc
          export CXX=i686-w64-mingw32-g++

          go install github.com/akavel/rsrc@v0.10.1
          echo "=== rsrc diagnostics ==="
          which rsrc.exe || { echo "rsrc.exe NOT in PATH"; exit 1; }

          echo "GOARCH=$GOARCH CGO_ENABLED=$CGO_ENABLED GOPATH_MSYS=$GOPATH_MSYS"
          go version
          gcc --version | head -n1

          mkdir -p dist

          if [ -f "assets/app.ico" ]; then
            rsrc.exe -arch ${GOARCH} -ico assets/app.ico -o rsrc.syso
            echo "objdump -f rsrc.syso:"
            objdump -f rsrc.syso || true
          fi

          go build -v \
            -tags desktop \
            -trimpath \
            -ldflags "-s -w -H windowsgui -X main.Version=$APP_VERSION" \
            -o dist/singbox-launcher-win7-32.exe .

          ls -lh dist/singbox-launcher-win7-32.exe

      - name: Upload artifacts (Win7 x86)
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-windows-win7-32
          path: dist/singbox-launcher-win7-32.exe
          retention-days: ${{ startsWith(github.ref, 'refs/tags/') && 1 || 30 }}


  release:
    name: Create Release
    needs: [meta, build, build-win7]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: needs.build.result == 'success' &&
        (startsWith(github.ref, 'refs/tags/v') ||
         (github.event_name == 'workflow_dispatch' && github.event.inputs.run_mode == 'prerelease'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      # IMPORTANT: Create/push prerelease tag early (before uploading a release).
      - name: Create and push prerelease tag (workflow_dispatch prerelease)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_mode == 'prerelease'
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ needs.meta.outputs.tag }}"
          if [[ -z "$TAG" ]]; then
            echo "Error: meta.outputs.tag is empty"
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git show-ref --tags --verify --quiet "refs/tags/$TAG"; then
            echo "Tag already exists: $TAG"
          else
            git tag -a "$TAG" -m "prerelease $TAG"
            git push origin "$TAG"
            echo "Created and pushed tag: $TAG"
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Create release packages
        shell: bash
        run: |
          set -euo pipefail
          cd release-artifacts

          VERSION="${{ needs.meta.outputs.version }}"
          echo "=== Creating release packages for version: $VERSION ==="
          echo ""

          echo "=== Cleaning up unwanted files/directories ==="
          if [ -d "logs" ]; then
            echo "⚠ Found logs directory, removing it..."
            rm -rf logs
          fi
          find . -name "*.log" -type f -delete 2>/dev/null || true
          find . -name "*.tmp" -type f -delete 2>/dev/null || true
          echo ""

          MACOS_APP=$(find . -name "singbox-launcher.app" -type d | head -1 || true)
          if [ -n "${MACOS_APP:-}" ]; then
            echo "✓ Found singbox-launcher.app, creating ZIP..."
            zip -r "singbox-launcher-${VERSION}-macos.zip" "$MACOS_APP"
            echo "✓ Created: singbox-launcher-${VERSION}-macos.zip"
          else
            echo "⚠ Warning: singbox-launcher.app not found"
          fi

          # Also check for a Catalina-targeted build artifact
          MACOS_APP_CATALINA=$(find . -name "singbox-launcher-macos-catalina.app" -type d | head -1 || true)
          if [ -n "${MACOS_APP_CATALINA:-}" ]; then
            echo "✓ Found Catalina-targeted app, creating ZIP..."
            zip -r "singbox-launcher-${VERSION}-macos-catalina.zip" "$MACOS_APP_CATALINA"
            echo "✓ Created: singbox-launcher-${VERSION}-macos-catalina.zip"
          fi

          WIN_EXE=$(find . -name "singbox-launcher.exe" -type f -size +0 | head -1 || true)
          if [ -n "${WIN_EXE:-}" ]; then
            echo "✓ Found singbox-launcher.exe at: $WIN_EXE"
            echo "Creating ZIP with only the .exe file (no directory structure)..."
            EXE_DIR=$(dirname "$WIN_EXE")
            EXE_NAME=$(basename "$WIN_EXE")
            ORIGINAL_DIR=$(pwd)
            cd "$EXE_DIR"
            zip -j "${ORIGINAL_DIR}/singbox-launcher-${VERSION}-win64.zip" "$EXE_NAME"
            cd "$ORIGINAL_DIR"
            echo "✓ Created: singbox-launcher-${VERSION}-win64.zip"
            echo ""
            echo "=== ZIP contents verification ==="
            unzip -l "singbox-launcher-${VERSION}-win64.zip" || true
          else
            echo "⚠ Warning: singbox-launcher.exe not found"
            find . -name "*.exe" -type f || echo "No .exe files found"
          fi

          echo ""
          echo "=== Creating checksums ==="
          # Include both macos and macos-catalina zips if present
          find . -name "singbox-launcher-${VERSION}-macos*.zip" -type f -size +0 -exec sha256sum {} \; > checksums.txt
          if [ -f checksums.txt ] && [ -s checksums.txt ]; then
            echo "Checksums created:"
            cat checksums.txt
          else
            echo "⚠ Warning: checksums.txt is empty"
            : > checksums.txt
          fi

          echo ""
          echo "=== Files to upload ==="
          ls -lh singbox-launcher-${VERSION}-*.zip checksums.txt 2>/dev/null || true

      - name: Read release notes
        id: release_notes
        shell: bash
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            TEMP_FILE=$(mktemp)
            cat RELEASE_NOTES.md > "$TEMP_FILE"
            DELIMITER="RELEASE_NOTES_EOF_b8f0dt821h7"
            {
              echo "notes<<${DELIMITER}"
              cat "$TEMP_FILE"
              echo "${DELIMITER}"
            } >> $GITHUB_OUTPUT
            rm -f "$TEMP_FILE"
            echo "✓ Found RELEASE_NOTES.md"
          else
            echo "notes=" >> $GITHUB_OUTPUT
            echo "⚠ RELEASE_NOTES.md not found, skipping custom notes"
          fi

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.meta.outputs.tag }}
          name: ${{ needs.meta.outputs.channel }} ${{ needs.meta.outputs.version }}
          fail_on_unmatched_files: false
          files: |
            release-artifacts/singbox-launcher-${{ needs.meta.outputs.version }}-macos.zip
            release-artifacts/singbox-launcher-${{ needs.meta.outputs.version }}-macos-catalina.zip
            release-artifacts/singbox-launcher-${{ needs.meta.outputs.version }}-win64.zip
            release-artifacts/checksums.txt
          body: |
            ## Release ${{ needs.meta.outputs.version }}

            ### Downloads

            #### macOS (Universal) - Supports both Apple Silicon and Intel

            **Option 1: Installation Script (Recommended)**

            Install with a single command:
            ```bash
            # Install latest version (auto-detects version and Catalina build if needed)
            curl -fsSL https://raw.githubusercontent.com/Leadaxe/singbox-launcher/develop/scripts/install-macos.sh | bash
            ```

            The script will:
            - Download the release archive
            - Extract and install to `/Applications/`
            - Fix macOS quarantine attributes and permissions
            - Launch the application automatically

            **Option 2: Manual Installation**

            1. Download: `singbox-launcher-${{ needs.meta.outputs.version }}-macos.zip`
            2. Extract the ZIP file
            3. Remove quarantine attribute (required):
               ```bash
               xattr -cr "singbox-launcher.app" && chmod +x "singbox-launcher.app/Contents/MacOS/singbox-launcher"
               ```
            4. Double-click `singbox-launcher.app` to run
               - If macOS blocks the app, go to **System Settings → Privacy & Security** and click **"Open Anyway"**
               - Alternatively, right-click the app and select **"Open"** (first time only)

            #### Windows (amd64)

            1. Download: `singbox-launcher-${{ needs.meta.outputs.version }}-win64.zip`
            2. Extract the ZIP file to a folder, for example: `C:\Program Files\singbox-launcher\`
            3. Run `singbox-launcher.exe` from that folder
               - You may need administrator rights to install to Program Files
               - The launcher will automatically download `sing-box` and `wintun.dll` on first launch

            #### Linux Support

            ⚠️ **Linux build temporarily unavailable** - мы ищем тестировщика для ручного тестирования перед включением автоматической сборки.

            ### Checksums

            See `checksums.txt` for SHA256 checksums of all files.

            ${{ steps.release_notes.outputs.notes }}
          draft: true
          prerelease: ${{ needs.meta.outputs.prerelease }}
